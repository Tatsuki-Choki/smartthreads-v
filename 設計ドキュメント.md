# 設計ドキュメント - Threads自動運用ツール v0.2

最終更新日: 2025-08-11
作成者: GPT-5 Thinking
対象読者: プロダクトオーナー、エンジニア、SRE、デザイナー

---

## 1. 概要

Threadsの公式APIとWebhooksを用いて、以下を提供するWebアプリケーションの設計を定義する。

* 即時投稿
* 予約投稿
* 通常投稿、ツリー型投稿、引用投稿
* 新着コメント検知とキーワード応答の自動返信
* 管理UIと権限管理
* レート制御と運用モニタリング

**インフラ前提**: デプロイは **Vercel Pro**。データと認証は **Supabase（Postgres＋Auth＋Storage）**。

---

## 2. 目標と非目標

### 目標

* MVPから小規模運用をVercel＋Supabaseで迅速にリリース
* レート制限遵守と安定稼働を両立
* 他ワークスペースのデータが絶対に見えないマルチテナント分離

### 非目標

* 他クラウドへの拡張・移行は本設計では扱わない

---

## 3. 想定ユースケース

* 単一または複数のThreadsアカウント運用
* 予約投稿の一括投入、当日分の分散送出
* 投稿直後やキャンペーン期間のコメント急増に対する自動返信

---

## 4. 機能要件

1. 投稿

   * 即時投稿: テキスト、画像、動画、カルーセル
   * 予約投稿: 指定時刻に送出
   * ツリー投稿: 親投稿に対する連続返信でスレッド化
   * 引用投稿: 既存投稿の引用
2. コメント検知と自動返信

   * Webhookで新着コメント受信
   * キーワード規則に合致時に返信テンプレート適用
3. 管理UI

   * 投稿作成、予約管理、ルール管理、レート状況表示
4. 監査とログ

   * 送出リクエスト、Webhookイベント、失敗要因を記録
5. 権限

   * ワークスペース、メンバー、ロールベース権限

---

## 5. 非機能要件

* 可用性: Vercel Pro運用相当
* パフォーマンス: Webhook処理p95 1秒未満、投稿API呼び出しp95 3秒未満の目安
* セキュリティ: OAuthスコープ最小化、Webhook署名検証、RLS徹底
* 監視運用: メトリクスとアラート閾値を定義、日次レポート

---

## 6. システム構成（Vercel＋Supabase）

```
ユーザー(UI) → Vercel Frontend (Next.js)
                 ↓
             Vercel Functions (REST API)
                 ↓
           Supabase Postgres（RLS有効）
                 ↓
           Supabase Storage（privateバケット）

Threads Webhooks → Vercel Webhook Endpoint
Vercel Cron → 予約到来チェック → Functionsで送出
```

---

## 7. データモデル（概略）

* workspaces
* workspace\_members
* threads\_accounts
* posts
* rules
* event\_log
* delivery\_attempts
* rate\_counters

---

## 8. APIインターフェース（抽象）

* POST /api/workspace/select
* POST /api/publish
* POST /api/schedule
* POST /api/rules
* POST /api/webhooks/threads
* GET /api/metrics

---

## 9. Webhook設計

* エンドポイント: POST /api/webhooks/threads
* セキュリティ: 署名＋タイムスタンプ検証
* コメントイベント抽出→ルール評価→返信

---

## 10. 予約投稿の送出設計

* Cron間隔: 1～5分
* 到来分送出→レート残量でフェアスケジューリング
* 失敗は軽量再試行＋delivery\_attempts記録

---

## 11. レート制御

* トークンバケット（post, reply, media）
* 上限は日次＋短時間スロット
* ヘッダー残量で動的補正

---

## 12. エラーハンドリングと再試行

* 一時障害: バックオフ最大N回
* 永続障害: 即時failed＋通知

---

## 13. セキュリティ

* Supabase RLSでworkspace\_id完全分離
* JWTの `current_workspace_id` を利用
* 全APIで `x-workspace-id` 必須＋メンバー検証
* Storageはworkspace\_id一致で許可
* トークンは暗号化保存し、送出直前に復号
* 監査対象操作はevent\_logに記録

---

## 14. 環境変数

* THREADS\_APP\_ID
* THREADS\_APP\_SECRET
* THREADS\_ACCESS\_TOKEN\_\<ACCOUNT\_ID>
* NEXT\_PUBLIC\_SUPABASE\_URL
* NEXT\_PUBLIC\_SUPABASE\_ANON\_KEY
* SUPABASE\_SERVICE\_ROLE\_KEY
* DB\_URL
* STORAGE\_BUCKET
* RATE\_LIMIT\_DEFAULTS\_JSON
* CRON\_INTERVAL\_MINUTES

---

## 15. メトリクスとアラート

* 成功率
* 遅延p95
* レート残量

---

## 16. 運用オペレーション

* 日次レポート
* リリース手順
* ロールバック方法

---

## 17. デプロイ手順（Vercel）

1. リポジトリ連携
2. 環境変数設定
3. Webhook URL登録
4. DBマイグレーション
5. Cronジョブ作成
6. 本番デプロイ

---

## 18. テスト計画

* 単体
* 結合
* 負荷
* 回帰

---

## 19. Claude Code用MCP一覧

### 必須

1. **Supabase MCP** – PostgresへのDDL/RLS適用、SQL実行、Storage操作、Auth管理
2. **HTTP/REST MCP** – Threads APIやWebhook検証のHTTPリクエスト送信
3. **Process/Command MCP** – Vercel CLI実行、環境変数設定、デプロイ

### 推奨

4. **Playwright MCP** – 管理UIのE2Eテスト自動化
5. **OpenAPI MCP** – Threads API仕様の取り込みと型安全なリクエスト生成

### 任意

6. **Git MCP** – ブランチ管理・差分レビュー・タグ付け
7. **Secrets/.env MCP** – 環境変数や機密情報を直接設定・ローテーション

---

## 20. API疑似例

* 予約作成例
* Webhook受信例

---

## 20. 開発運用: Claude Code のMCP構成

### 20.1 必須（Must）

1. **Supabase MCP**

   * 役割: Postgres DDL/RLS適用、SQL実行、Storage操作、Auth管理。
   * 用途: マイグレーション適用、RLSポリシー検証、Storageの署名URL・メタ設定。
   * 最低権限: `service_role` キーはサーバー関数専用。ローカル利用時は厳重管理。

2. **HTTP/REST MCP（汎用HTTPクライアント）**

   * 役割: Threads APIの呼び出し検証、Webhook署名検証の再現。
   * 用途: `/api/publish` 下位呼び出しの実機テスト、Webhookのリプレイ。

3. **Process/Command MCP（ローカルCLIブリッジ）**

   * 役割: Vercel CLIの実行（デプロイ、環境変数投入、Cron設定）。
   * 用途: `vercel env add`, `vercel deploy`, Webhook URLの差し替え。

### 20.2 推奨（Should）

4. **Playwright MCP**

   * 役割: 管理UIのE2E（ログイン→WS切替→投稿→予約→送出→ログ確認）。
   * 用途: 回帰の自動化、p95遅延や失敗時の画面キャプチャ取得。

5. **OpenAPI MCP（任意）**

   * 役割: エンドポイント仕様から型付きリクエスト雛形を生成。
   * 用途: 投稿・返信APIのパラメータ変更への追従。

### 20.3 任意（Nice to have）

6. **Git MCP**

   * 役割: ブランチ運用・差分レビュー・タグ作成。

7. **Secrets/.env MCP**

   * 役割: 環境変数の安全な投入（`THREADS_APP_ID`, `THREADS_APP_SECRET`, `THREADS_ACCESS_TOKEN_*` 等）。

### 20.4 導入メモ（最小手順の目安）

* 前提: Vercel CLI / Supabase CLI にログイン済み。
* 環境変数: Threads関連・Supabase関連・Cron間隔などをVercelに登録。
* セキュリティ: `service_role` はクライアント配布禁止。MCPの実行範囲を端末ローカルに限定。
* 実運用フロー:

  1. Supabase MCPでDDL/RLS適用  →  2) Process MCPでVercel環境変数投入  →  3) HTTP MCPでAPI/Webhook疎通  →  4) Playwright MCPでE2E回帰。
