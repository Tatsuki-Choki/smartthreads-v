# ワークスペース読み込み問題の改修要件定義

## 問題の概要
設定ページでThreads連携ボタンが「読み込み中...」のまま活性化しない。根本原因はワークスペース情報が正しく取得できていないため。

## 現状分析

### 1. 現在の問題点
- `/api/workspaces` APIがワークスペース情報を返していない
- ユーザーがログインしてもworkspace_membersテーブルにレコードが作成されていない
- RLSポリシーは修正済みだが、そもそもデータが存在しない

### 2. データフロー
```
ログイン
  ↓
Supabase Auth (成功)
  ↓
/dashboard へリダイレクト
  ↓ 
useWorkspace hook実行
  ↓
/api/workspaces 呼び出し
  ↓
❌ ワークスペースデータが空（workspace_membersにレコードがない）
```

## 改修方針

### Phase 1: ワークスペース初期化の確実な実行
1. **ログイン後の初期化処理を強化**
   - `/api/auth/initialize` を確実に呼び出す
   - 初期化成功を確認してからダッシュボードへ遷移

2. **初期化APIの改善**
   - usersテーブルへのレコード作成
   - デフォルトワークスペースの作成
   - workspace_membersへの紐付け
   - トランザクション処理で原子性を保証

### Phase 2: ワークスペースAPI修正
1. **`/api/workspaces` の修正**
   - Service Roleキーを使用した確実なデータ取得
   - ワークスペースが存在しない場合の自動作成
   - エラーハンドリングの強化

2. **デバッグログの追加**
   - 各ステップでの詳細なログ出力
   - エラー時の詳細情報記録

### Phase 3: フロントエンド改善
1. **useWorkspaceフックの改善**
   - リトライ機能の追加
   - エラー時の適切なフィードバック
   - ローディング状態の管理

## 実装計画

### 1. 初期化処理の改善 (優先度: 高)
```typescript
// /api/auth/initialize/route.ts
- Service Roleキーを使用
- トランザクション処理
- 詳細なログ出力
- エラーハンドリング強化
```

### 2. ワークスペースAPI修正 (優先度: 高)
```typescript
// /api/workspaces/route.ts
- ワークスペースが存在しない場合の自動作成
- Service Roleキーでの確実なデータ取得
- デバッグ情報の追加
```

### 3. ログインフロー修正 (優先度: 高)
```typescript
// /app/(auth)/login/page.tsx
- 初期化APIの確実な呼び出し
- 成功確認後のリダイレクト
- エラー時のリトライ
```

### 4. データベース初期データ作成 (優先度: 中)
```sql
-- テストユーザー用の初期データ作成
-- users, workspaces, workspace_membersへのレコード挿入
```

## 成功基準
1. ログイン後、ワークスペース情報が確実に取得できる
2. 設定ページでThreads連携ボタンが活性化する
3. エラーが発生した場合、適切なエラーメッセージが表示される

## テスト項目
1. 新規ユーザーのログインとワークスペース自動作成
2. 既存ユーザーのログインとワークスペース取得
3. エラー時のリトライ機能
4. Threads連携ボタンの活性化