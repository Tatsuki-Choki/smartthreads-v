# ワークスペース初期化問題 - 要件定義

## 🔍 現状の問題

### 問題の概要
- **症状**: Threads連携ボタンが「読み込み中...」のまま活性化しない
- **原因**: ワークスペース情報が正しく取得・設定されていない
- **影響**: Threads連携機能が使用できない

### 調査結果

1. **API側の問題点** (`/api/workspaces/route.ts`)
   - `skipAuth = true`でダミーユーザーID使用中: `c1234567-89ab-cdef-0123-456789abcdef`
   - RLSポリシーが実際のユーザーIDを期待しているが、ダミーIDではデータ取得不可

2. **フロントエンド側の問題点** (`useWorkspace.tsx`)
   - ワークスペースが0件の場合、デフォルトワークスペース作成処理はあるが、
   - API側のダミーユーザーとの不整合で正しく機能しない

3. **データベース側の問題点**
   - `users`テーブルに実際のユーザーレコードが存在しない
   - `workspace_members`テーブルとのJOINが失敗

## 📋 解決要件

### 1. ユーザー初期化処理
- **要件**: ログイン時に`users`テーブルにユーザーレコードを自動作成
- **タイミング**: 初回ログイン時またはユーザー情報取得時
- **必須フィールド**: `id`（auth.uid()）、`email`

### 2. ワークスペース初期化処理
- **要件**: ユーザー作成後、デフォルトワークスペースを自動作成
- **ワークスペース名**: `{ユーザー名}のワークスペース` または `マイワークスペース`
- **メンバー追加**: 作成者を`owner`権限で自動追加

### 3. API認証の修正
- **開発環境**: 実際のSupabase認証を使用（`SKIP_AUTH_CHECK`を削除）
- **本番環境**: 必須の認証チェック
- **セッション管理**: クッキーベースの認証を適切に処理

### 4. エラーハンドリング
- **RLSエラー**: ユーザーがいない場合の初期化処理
- **ワークスペース不在**: 自動作成とリトライ
- **API応答**: 適切なエラーメッセージとステータスコード

## 🛠️ 実装計画

### Phase 1: ユーザー初期化（優先度: 高）
1. ログイン成功時のコールバックでユーザーレコード作成
2. `/api/auth/callback`エンドポイントの実装
3. `users`テーブルへのINSERT処理（重複チェック付き）

### Phase 2: ワークスペース自動作成（優先度: 高）
1. ユーザー初期化後のワークスペース作成
2. Admin権限でのデータ作成（RLS回避）
3. workspace_membersへの自動追加

### Phase 3: API認証修正（優先度: 中）
1. `SKIP_AUTH_CHECK`環境変数の削除
2. 実際の認証情報を使用
3. 認証エラーの適切なハンドリング

### Phase 4: フロントエンド改善（優先度: 低）
1. ローディング状態の改善
2. エラーメッセージの表示
3. リトライ機能の追加

## 🎯 成功基準

1. **新規ユーザー**: ログイン後、自動的にワークスペースが作成される
2. **既存ユーザー**: ワークスペース情報が正しく取得される
3. **Threads連携**: ボタンが活性化し、連携ページへ遷移可能
4. **エラー処理**: 失敗時に適切なメッセージが表示される

## ⚠️ 注意事項

- RLSポリシーを考慮した実装が必要
- Admin権限（service_role_key）の適切な使用
- 既存データとの互換性維持
- セキュリティを損なわない実装

## 📝 テストケース

1. **新規ユーザーログイン**
   - usersテーブルにレコード作成
   - デフォルトワークスペース作成
   - Threads連携ボタン活性化

2. **既存ユーザーログイン**
   - 既存ワークスペース取得
   - Threads連携ボタン活性化

3. **エラーケース**
   - ネットワークエラー時のリトライ
   - RLSエラー時の初期化処理