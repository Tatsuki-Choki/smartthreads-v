# 投稿複製機能 要件定義書

## 1. 機能概要
既存の投稿（投稿履歴・予約投稿）を複製して、新規投稿画面で編集できる機能

## 2. ユーザーストーリー
- 過去に投稿した内容を再利用したい
- 予約投稿を別の日時で再投稿したい
- 定型文や告知を効率的に投稿したい

## 3. 機能要件

### 3.1 複製元
1. **投稿履歴** (/posts/history)
   - 公開済み投稿から複製
   - 失敗した投稿からも複製可能

2. **予約投稿** (/posts/scheduled)
   - 予約中の投稿から複製
   - 編集と複製を使い分け

### 3.2 複製対象データ
- 投稿内容（content）
- 投稿タイプ（通常/ツリー）
- ツリー投稿の場合は全ての投稿内容
- ※日時は複製しない（新規作成扱い）
- ※投稿IDは新規生成

### 3.3 UI/UX要件
1. **複製ボタン**
   - 各投稿カードに「複製」ボタンを追加
   - アイコン: Copy または Duplicate
   - 既存の編集・削除ボタンと並列配置

2. **データ受け渡し方法**
   - URLパラメータ: `/posts/new?duplicate=${postId}`
   - または
   - LocalStorage: 一時的にデータを保存

3. **新規投稿画面での処理**
   - 複製データがある場合は自動入力
   - 「複製から作成」のメッセージ表示
   - 通常の新規作成と同じ編集が可能

## 4. 技術実装方針

### 4.1 データフロー
```
1. 複製ボタンクリック
   ↓
2. 投稿データ取得（API: GET /api/posts/[id]）
   ↓
3. LocalStorageに保存
   ↓
4. 新規投稿ページへ遷移（/posts/new?mode=duplicate）
   ↓
5. LocalStorageからデータ読み込み
   ↓
6. フォームに自動入力
   ↓
7. LocalStorageクリア
```

### 4.2 LocalStorageキー
- `duplicatePost`: 複製データ保存用
- `duplicatePostTimestamp`: タイムスタンプ（24時間で自動削除）

### 4.3 セキュリティ考慮
- 他ユーザーの投稿は複製不可（APIレベルで制御）
- LocalStorageは同一ドメインのみアクセス可能
- 24時間経過した複製データは自動削除

## 5. 実装ファイル

### 5.1 修正ファイル
1. `/app/(dashboard)/posts/history/page.tsx`
   - 複製ボタン追加
   - handleDuplicate関数実装

2. `/app/(dashboard)/posts/scheduled/page.tsx`
   - 複製ボタン追加
   - handleDuplicate関数実装

3. `/app/(dashboard)/posts/new/page.tsx`
   - URLパラメータ確認
   - LocalStorageデータ読み込み
   - フォーム自動入力

### 5.2 共通コンポーネント（オプション）
- `/components/post-duplicate-button.tsx`
  - 複製ボタンコンポーネント
  - 複製処理ロジック

## 6. 実装手順

### Phase 1: 投稿履歴に複製ボタン追加（15分）
1. 複製ボタンUI追加
2. handleDuplicate関数実装
3. LocalStorage保存処理

### Phase 2: 予約投稿に複製ボタン追加（10分）
1. 複製ボタンUI追加
2. 共通処理の再利用

### Phase 3: 新規投稿画面で複製データ処理（20分）
1. URLパラメータチェック
2. LocalStorageデータ読み込み
3. フォーム自動入力
4. メッセージ表示

### Phase 4: テスト（10分）
1. 通常投稿の複製
2. ツリー投稿の複製
3. エラーケースのテスト

## 7. エラーハンドリング
- 投稿が見つからない: 「複製元の投稿が見つかりません」
- 権限エラー: 「この投稿を複製する権限がありません」
- LocalStorageエラー: フォールバックとしてURLパラメータ使用

## 8. 将来の拡張
- テンプレート機能（よく使う投稿を保存）
- 一括複製（複数投稿を選択して複製）
- 複製時の自動編集（日付や番号の自動更新）